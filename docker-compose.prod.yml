services:
  dht11-sensor:
    build: ./apps/rp
    container_name: dht11-sensor-app
    privileged: true # Required for GPIO access
    environment:
      - PYTHONUNBUFFERED=1
      - INFLUXDB_URL=${INFLUXDB_URL}
      - INFLUXDB_TOKEN=${INFLUXDB_RW_TOKEN}
      - INFLUXDB_ORG=${INFLUXDB_ORG}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET}
    devices:
      - '/dev/gpiomem:/dev/gpiomem' # GPIO memory access
      - '/dev/mem:/dev/mem' # Memory access
    volumes:
      - /sys:/sys:ro # Read-only access to system info
      # - ./apps/rp/logs:/app/logs # Optional: mount logs directory
    restart: unless-stopped
    depends_on:
      - influxdb
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=${DOCKER_INFLUXDB_INIT_MODE}
      - DOCKER_INFLUXDB_INIT_USERNAME=${DOCKER_INFLUXDB_INIT_USERNAME}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${DOCKER_INFLUXDB_INIT_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${DOCKER_INFLUXDB_INIT_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${DOCKER_INFLUXDB_INIT_BUCKET}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${DOCKER_INFLUXDB_INIT_ADMIN_TOKEN}
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2
    restart: unless-stopped

  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: grafana
  #   environment:
  #     - GF_SECURITY_ADMIN_USER=admin
  #     - GF_SECURITY_ADMIN_PASSWORD=admin
  #     - GF_USERS_ALLOW_SIGN_UP=false
  #   volumes:
  #     - grafana-data:/var/lib/grafana
  #     - ./grafana/provisioning:/etc/grafana/provisioning
  #   restart: unless-stopped
  #   depends_on:
  #     - influxdb

  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: meter-web
    environment:
      - NODE_ENV=production
      - PUBLIC_INFLUXDB_URL=${PUBLIC_INFLUXDB_URL}
      - PUBLIC_INFLUXDB_TOKEN=${PUBLIC_INFLUXDB_RO_TOKEN}
      - PUBLIC_INFLUXDB_ORG=${PUBLIC_INFLUXDB_ORG}
      - PUBLIC_INFLUXDB_BUCKET=${PUBLIC_INFLUXDB_BUCKET}
      - PUBLIC_INFLUXDB_MEASUREMENT=${PUBLIC_INFLUXDB_MEASUREMENT}
    depends_on:
      - influxdb
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  influxdb-data:
  influxdb-config:
  grafana-data:
